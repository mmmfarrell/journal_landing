% !TEX root=./root.tex

\subsection{Propagation Model}
We use common rigid body kinematics to model the dynamics of
the UAV given by
\begin{align}
  \dot{\vect{p}}_{b/I}^I
  &=
  \left( R_I^b \right)^\transpose \vect{v}_{b/I}^b
  \label{eq:uav_dynamics}
  \\
  \dot{\vect{q}}_{I}^{b} 
	&= 	
  \q_I^b \otimes \begin{pmatrix} 0 \\ \frac{1}{2}
    \left( \bar{\vect{\omega}}_{b/I}^b - \vect{\beta}_\omega - \vect{\upsilon}_\omega \right)
\end{pmatrix} \nonumber \\
  \dot{\vect{v}}_{b/I}^b 
  &=
  R_I^b \vect{g}
  +
  \skewmat{\vect{v}_{b/I}^b}
  \left( \bar{\vect{\omega}}_{b/I}^b - \vect{\beta}_\omega -
  \vect{\upsilon}_\omega \right)
  +
  \left( \bar{\vect{a}} - \vect{\beta}_a - \vect{\upsilon}_a \right) \nonumber
  % \vect{\eta}_v 
  \\
  \dot{\vect{\beta}}_a &= \vect{\eta}_{\beta_a} \nonumber
  \\
  \dot{\vect{\beta}}_\omega &= \vect{\eta}_{\beta_\omega} \nonumber
\end{align}
% $\vect{\eta}_v$, 
where $\vect{\eta}_{\beta_a}$, $\vect{\eta}_{\beta_\omega}$,
$\vect{\upsilon}_\omega$, and $\vect{\upsilon}_a$
are zero-mean Gaussian noise processes.

We model the motion of the landing vehicle
with a constant velocity and constant
angular velocity motion model such that
% Though this is a very simplified model, we show
% in~\secref{sec:simulation} and~\secref{sec:hardware} that it is sufficient for
% cases that do not perfectly match this model. The dynamics of $\x_{\text{Goal}}$ are expressed as
% \begin{align}
  % \dot{\hat{\vect{p}}}_{g/b}^{v} &= \left( \hat{R}_{I}^{g} \right)^\transpose
  % \hat{\vect{v}}_{g/I}^{g} - \left( \hat{R}_{I}^{b} \right)^\transpose
  % \hat{\vect{v}}_{b/I}^{b} \label{eq:goal_dynamics} \\
  % \dot{\hat{\vect{v}}}_{g/I}^{g} &= \vect{0} \nonumber \\
  % \dot{\hat{\theta}}_{I}^{g} &= \hat{\omega}_{g/I}^g \nonumber \\
  % \dot{\hat{\omega}}_{g/I}^{g} &= 0. \nonumber
% \end{align}
\begin{align}
  \dot{\vect{p}}_{g/b}^{v} &= I_{3 \times 2} \left( R_{I}^{g} \right)^\transpose
   \vect{v}_{g/I}^{g} - \left( R_{I}^{b} \right)^\transpose
  \vect{v}_{b/I}^{b} \label{eq:goal_dynamics} \\
  \dot{\vect{v}}_{g/I}^{g} &= \vect{\eta}_{gv} \nonumber \\
  \dot{\psi}_{I}^{g} &= \omega_{g/I}^g \nonumber \\
  \dot{\omega}_{g/I}^{g} &= \eta_{g\omega} \nonumber
\end{align}
where $\vect{\eta}_{gv}$ and $\eta_{g\omega}$ are zero-mean Gaussian noise
processes. Though this is a very simplified motion model for the landing
vehicle, we show in~\secref{sec:simulation} and~\secref{sec:hardware} that is is
satisfactory for our experiments. We intend the motion model of the landing
vehicle to be easily modified for landing vehicles with more complex motion such
as a boat at sea.

As mentioned previously, we assume the tracked visual features are rigidly
attached to the landing vehicle such that
% there are no dynamics 
% of their associated states
\begin{equation}
  \dot{\vect{r}}_{i/g}^g = \vect{0}. \label{eq:feature_dynamics}
  % \dot{\hat{\vect{r}}}_{i/g}^g = \vect{0}. \label{eq:feature_dynamics}
\end{equation}

In the ESKF, the estimated state is propagated independently of the filter using
the expected value of the modeled dynamics. We use the expected values
of~\eqref{eq:uav_dynamics}, \eqref{eq:goal_dynamics}, and
\eqref{eq:feature_dynamics} given by
% The estimated state is propagated
\begin{align}
  \dot{\hat{\vect{p}}}_{b/I}^I
  &=
  \left( \hat{R}_I^b \right)^\transpose \hat{\vect{v}}_{b/I}^b
  \label{eq:estimated_dynamics}
  \\
  \dot{\hat{\vect{q}}}_{I}^{b} 
  &= 	
  \hat{\q}_I^b \otimes \begin{pmatrix} 0 \\ \frac{1}{2}
  \left( \bar{\vect{\omega}}_{b/I}^b - \hat{\vect{\beta}}_\omega \right)
\end{pmatrix} \nonumber \\
  \dot{\hat{\vect{v}}}_{b/I}^b 
  &=
  \hat{R}_I^b \vect{g}
  +
  \skewmat{\hat{\vect{v}}_{b/I}^b}
  \left( \bar{\vect{\omega}}_{b/I}^b - \hat{\vect{\beta}}_\omega \right)
  +
  \left( \bar{\vect{a}} - \hat{\vect{\beta}}_a \right) \nonumber
  \\
  \dot{\hat{\vect{\beta}}}_a &= \vect{0} \nonumber
  \\
  \dot{\hat{\vect{\beta}}}_\omega &= \vect{0} \nonumber
  \\
  \dot{\hat{\vect{p}}}_{g/b}^{v} &= I_{3 \times 2} \left( \hat{R}_{I}^{g} \right)^\transpose
   \hat{\vect{v}}_{g/I}^{g} - \left( \hat{R}_{I}^{b} \right)^\transpose
  \hat{\vect{v}}_{b/I}^{b} \nonumber \\
  \dot{\hat{\vect{v}}}_{g/I}^{g} &= \vect{0} \nonumber \\
  \dot{\hat{\psi}}_{I}^{g} &= \hat{\omega}_{g/I}^g \nonumber \\
  \dot{\hat{\omega}}_{g/I}^{g} &= 0 \nonumber \\
  \dot{\hat{\vect{r}}}_{i/g}^g &= \vect{0}. \nonumber
\end{align}

The error-state dynamics used to propagate the filter are found by relating
the modeled true-state dynamics from~\eqref{eq:uav_dynamics},
\eqref{eq:goal_dynamics}, and \eqref{eq:feature_dynamics}
with~\eqref{eq:estimated_dynamics} using the error-state definitions
from~\eqref{eq:est_paper_vector_error_state} and~\eqref{eq:quat_error_state}. The
first-order approximation of the error-state dynamics are given by 
\begin{align}
  \dot{\tilde{\vect{p}}}_{b/I}^I
  &\approx
  \left( \hat{R}_I^b \right)^\transpose \tilde{\vect{v}}_{b/I}^b
  - \left( \hat{R}_I^b \right)^\transpose \skewmat{\hat{\vect{v}}_{b/I}^b}
  \tilde{\vect{\theta}}_I^b
  \\
  \dot{\tilde{\vect{\theta}}}_{I}^{b} 
  &\approx 	
  -\skewmat{ \bar{\vect{\omega}}_{b/I}^b - \hat{\vect{\beta}}_\omega}
    \tilde{\vect{\theta}}_I^b
    - \tilde{\vect{\beta}}_\omega -
    \vect{\upsilon}_\omega
  \nonumber \\
  \dot{\tilde{\vect{v}}}_{b/I}^b 
  &\approx
  \skewmat{ \hat{R}_I^b \vect{g} } \tilde{\vect{\theta}}_I^b 
  -
  \skewmat{ \hat{\vect{v}}_{b/I}^b } \tilde{\vect{\beta}}_\omega
  -
  \skewmat{ \hat{\vect{v}}_{b/I}^b } \vect{\upsilon}_\omega
  -
  \skewmat{ \bar{\omega}_{b/I}^b - \hat{\vect{\beta}}_\omega }
  \tilde{\vect{v}}_{b/I}^b
  -
  \tilde{\vect{\beta}}_a
  -
  \vect{\upsilon}_a \nonumber
  \\
  \dot{\tilde{\vect{\beta}}}_a &= \vect{\eta}_{\beta_a} \nonumber
  \\
  \dot{\tilde{\vect{\beta}}}_\omega &= \vect{\eta}_{\beta_\omega} \nonumber
  \\
  \dot{\tilde{\vect{p}}}_{g/b}^{v}
                                  &\approx
  I_{3 \times 2} \left( \hat{R}_{I}^{g} \right)^\transpose
  \tilde{\vect{v}}_{g/I}^g
  +
  I_{3 \times 2} \left( \hat{R}_{I}^{g} \right)^\transpose
  \skewmat{ \tilde{\psi}_I^g } \hat{\vect{v}}_{g/I}^g
  +
  \left( \hat{R}_{I}^{b} \right)^\transpose \skewmat{ \hat{\vect{v}}_{b/I}^{b} } 
  \tilde{\vect{\theta}}_I^b
  -
  \left( \hat{R}_{I}^{b} \right)^\transpose \tilde{\vect{v}}_{b/I}^{b} \nonumber \\
  \dot{\tilde{\vect{v}}}_{g/I}^{g} &= \vect{\eta}_{gv} \nonumber \\
  \dot{\tilde{\psi}}_{I}^{g} &= TODO \nonumber \\
  \dot{\tilde{\omega}}_{g/I}^{g} &= \eta_{g\omega} \nonumber \\
  \dot{\tilde{\vect{r}}}_{i/g}^g &= \vect{0}. \nonumber
\end{align}
The derivation of these error-state dynamics can be found in
Appendix~\ref{apdx:estimation_err_state_derivation}.

I changed something here

