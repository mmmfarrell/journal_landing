% !TEX root=./root.tex

\subsection{Propagation Model}
We use common rigid body kinematics to model the dynamics of
the UAV given by
\begin{align}
  \dot{\vect{p}}_{b/I}^I
  &=
  \left( R_I^b \right)^\transpose \vect{v}_{b/I}^b
  \label{eq:uav_dynamics}
  \\
  \dot{\vect{q}}_{I}^{b} 
	&= 	
  \q_I^b \otimes \begin{pmatrix} 0 \\ \frac{1}{2}
    \left( \bar{\vect{\omega}}_{b/I}^b - \vect{\beta}_\omega - \vect{\upsilon}_\omega \right)
\end{pmatrix} \nonumber \\
  \dot{\vect{v}}_{b/I}^b 
  &=
  R_I^b \vect{g}
  +
  \skewmat{\vect{v}_{b/I}^b}
  \left( \bar{\vect{\omega}}_{b/I}^b - \vect{\beta}_\omega -
  \vect{\upsilon}_\omega \right)
  +
  \left( \bar{\vect{a}} - \vect{\beta}_a - \vect{\upsilon}_a \right) \nonumber
  % \vect{\eta}_v 
  \\
  \dot{\vect{\beta}}_a &= \vect{\eta}_{\beta_a} \nonumber
  \\
  \dot{\vect{\beta}}_\omega &= \vect{\eta}_{\beta_\omega} \nonumber
\end{align}
% $\vect{\eta}_v$, 
where $\vect{\eta}_{\beta_a}$, $\vect{\eta}_{\beta_\omega}$,
$\vect{\upsilon}_\omega$, and $\vect{\upsilon}_a$
are zero-mean Gaussian noise processes.

We model the motion of the landing vehicle
with a constant velocity and constant
angular velocity motion model such that
% Though this is a very simplified model, we show
% in~\secref{sec:simulation} and~\secref{sec:hardware} that it is sufficient for
% cases that do not perfectly match this model. The dynamics of $\x_{\text{Goal}}$ are expressed as
% \begin{align}
  % \dot{\hat{\vect{p}}}_{g/b}^{v} &= \left( \hat{R}_{I}^{g} \right)^\transpose
  % \hat{\vect{v}}_{g/I}^{g} - \left( \hat{R}_{I}^{b} \right)^\transpose
  % \hat{\vect{v}}_{b/I}^{b} \label{eq:goal_dynamics} \\
  % \dot{\hat{\vect{v}}}_{g/I}^{g} &= \vect{0} \nonumber \\
  % \dot{\hat{\theta}}_{I}^{g} &= \hat{\omega}_{g/I}^g \nonumber \\
  % \dot{\hat{\omega}}_{g/I}^{g} &= 0. \nonumber
% \end{align}
\begin{align}
  \dot{\vect{p}}_{g/b}^{v} &= \left( R_{I}^{g} \right)^\transpose
  \vect{v}_{g/I}^{g} - \left( R_{I}^{b} \right)^\transpose
  \vect{v}_{b/I}^{b} \label{eq:goal_dynamics} \\
  \dot{\vect{v}}_{g/I}^{g} &= \vect{\eta}_{gv} \nonumber \\
  \dot{\psi}_{I}^{g} &= \omega_{g/I}^g \nonumber \\
  \dot{\omega}_{g/I}^{g} &= \eta_{g\omega} \nonumber
\end{align}
where $\vect{\eta}_{gv}$ and $\eta_{g\omega}$ are zero-mean Gaussian noise
processes. Though this is a very simplified motion model for the landing
vehicle, we show in~\secref{sec:simulation} and~\secref{sec:hardware} that is is
satisfactory for our experiments. We intend the motion model of the landing
vehicle to be easily modified for landing vehicles with more complex motion such
as a boat at sea.

As mentioned previously, we assume the tracked visual features are rigidly
attached to the landing vehicle such that
% there are no dynamics 
% of their associated states
\begin{equation}
  \dot{\vect{r}}_{i/g}^g = \vect{0}. \label{eq:feature_dynamics}
  % \dot{\hat{\vect{r}}}_{i/g}^g = \vect{0}. \label{eq:feature_dynamics}
\end{equation}

In the ESKF, the estimated state is propagated independently of the filter using
the expected value of the modeled dynamics. We use the expected values
of~\eqref{eq:uav_dynamics}, \eqref{eq:goal_dynamics}, and
\eqref{eq:feature_dynamics} given by
% The estimated state is propagated
\begin{align}
  \dot{\hat{\vect{p}}}_{b/I}^I
  &=
  \left( \hat{R}_I^b \right)^\transpose \hat{\vect{v}}_{b/I}^b
  \label{eq:estimated_dynamics}
  \\
  \dot{\hat{\vect{q}}}_{I}^{b} 
  &= 	
  \hat{\q}_I^b \otimes \begin{pmatrix} 0 \\ \frac{1}{2}
  \left( \bar{\vect{\omega}}_{b/I}^b - \hat{\vect{\beta}}_\omega \right)
\end{pmatrix} \nonumber \\
  \dot{\hat{\vect{v}}}_{b/I}^b 
  &=
  \hat{R}_I^b \vect{g}
  +
  \skewmat{\hat{\vect{v}}_{b/I}^b}
  \left( \bar{\vect{\omega}}_{b/I}^b - \hat{\vect{\beta}}_\omega \right)
  +
  \left( \bar{\vect{a}} - \hat{\vect{\beta}}_a \right) \nonumber
  \\
  \dot{\hat{\vect{\beta}}}_a &= \vect{0} \nonumber
  \\
  \dot{\hat{\vect{\beta}}}_\omega &= \vect{0} \nonumber
  \\
  \dot{\hat{\vect{p}}}_{g/b}^{v} &= \left( \hat{R}_{I}^{g} \right)^\transpose
  \hat{\vect{v}}_{g/I}^{g} - \left( \hat{R}_{I}^{b} \right)^\transpose
  \hat{\vect{v}}_{b/I}^{b} \nonumber \\
  \dot{\hat{\vect{v}}}_{g/I}^{g} &= \vect{0} \nonumber \\
  \dot{\hat{\psi}}_{I}^{g} &= \hat{\omega}_{g/I}^g \nonumber \\
  \dot{\hat{\omega}}_{g/I}^{g} &= 0 \nonumber \\
  \dot{\hat{\vect{r}}}_{i/g}^g &= \vect{0}. \nonumber
\end{align}

The error-state dynamics used to propagate the filter are found by relating
the modeled true-state dynamics from~\eqref{eq:uav_dynamics},
\eqref{eq:goal_dynamics}, and \eqref{eq:feature_dynamics}
with~\eqref{eq:estimated_dynamics} using the error-state definitions
from~\eqref{eq:est_paper_vector_error_state} and~\eqref{eq:quat_error_state}. The
first-order approximation of the error-state dynamics are given by \MF{TODO put
the right err state dynamics here}
\begin{align}
  \dot{\hat{\vect{p}}}_{b/I}^I
  &=
  \left( \hat{R}_I^b \right)^\transpose \hat{\vect{v}}_{b/I}^b
  \\
  \dot{\hat{\vect{q}}}_{I}^{b} 
  &= 	
  \hat{\q}_I^b \otimes \begin{pmatrix} 0 \\ \frac{1}{2}
  \left( \bar{\vect{\omega}}_{b/I}^b - \hat{\vect{\beta}}_\omega \right)
\end{pmatrix} \nonumber \\
  \dot{\hat{\vect{v}}}_{b/I}^b 
  &=
  \hat{R}_I^b \vect{g}
  +
  \skewmat{\hat{\vect{v}}_{b/I}^b}
  \left( \bar{\vect{\omega}}_{b/I}^b - \hat{\vect{\beta}}_\omega \right)
  +
  \left( \bar{\vect{a}} - \hat{\vect{\beta}}_a \right) \nonumber
  \\
  \dot{\hat{\vect{\beta}}}_a &= \vect{0} \nonumber
  \\
  \dot{\hat{\vect{\beta}}}_\omega &= \vect{0} \nonumber
  \\
  \dot{\hat{\vect{p}}}_{g/b}^{v} &= \left( \hat{R}_{I}^{g} \right)^\transpose
  \hat{\vect{v}}_{g/I}^{g} - \left( \hat{R}_{I}^{b} \right)^\transpose
  \hat{\vect{v}}_{b/I}^{b} \nonumber \\
  \dot{\hat{\vect{v}}}_{g/I}^{g} &= \vect{0} \nonumber \\
  \dot{\hat{\psi}}_{I}^{g} &= \hat{\omega}_{g/I}^g \nonumber \\
  \dot{\hat{\omega}}_{g/I}^{g} &= 0 \nonumber \\
  \dot{\hat{\vect{r}}}_{i/g}^g &= \vect{0}. \nonumber
\end{align}
The derivation of these error-state dynamics can be found in the continuing
subsections.

\subsubsection{UAV Position Error-State Dynamics}
To derive the error-state dynamics for the UAV position state, we start by
differentiating the error-state definition given
in~\eqref{eq:est_paper_uav_pos_err_state} with respect to time to yield
\begin{equation}
  \dot{\tilde{\vect{p}}}_{b/I}^I = \dot{\vect{p}}_{b/I}^I - \dot{\hat{\vect{p}}}_{b/I}^I.
\end{equation}
We then substitue in the corresponding dynamics from~\eqref{eq:uav_dynamics}
and~\eqref{eq:estimated_dynamics}
\begin{align}
  \dot{\tilde{\vect{p}}}_{b/I}^I
  &=
  \left( R_I^b \right)^\transpose \vect{v}_{b/I}^b
  - \left( \hat{R}_I^b \right)^\transpose \hat{\vect{v}}_{b/I}^b.
\end{align}
We expand this equation using the approximation for $\left( R_I^b \right)^\transpose$ given
in~\eqref{eq:est_paper_RTapprox} and the error-state definition given
in~\eqref{eq:est_paper_vector_error_state} resulting in
\begin{align}
  \dot{\tilde{\vect{p}}}_{b/I}^I
  &=
  \left( \hat{R}_I^b \right)^\transpose
  \left( I + \skewmat{\tilde{\vect{\theta}}_I^b} \right)
  \left( \hat{\vect{v}}_{b/I}^b + \tilde{\vect{v}}_{b/I}^b \right)
  - \left( \hat{R}_I^b \right)^\transpose \hat{\vect{v}}_{b/I}^b \\
  &=
  \left( \hat{R}_I^b \right)^\transpose
  \left( \hat{\vect{v}}_{b/I}^b + \tilde{\vect{v}}_{b/I}^b
  + \skewmat{\tilde{\vect{\theta}}_I^b} \hat{\vect{v}}_{b/I}^b
  + \skewmat{\tilde{\vect{\theta}}_I^b} \tilde{\vect{v}}_{b/I}^b \right)
  - \left( \hat{R}_I^b \right)^\transpose \hat{\vect{v}}_{b/I}^b \\
  &=
  \left( \hat{R}_I^b \right)^\transpose \tilde{\vect{v}}_{b/I}^b
  + \left( \hat{R}_I^b \right)^\transpose \skewmat{\tilde{\vect{\theta}}_I^b} \hat{\vect{v}}_{b/I}^b
  + \left( \hat{R}_I^b \right)^\transpose \skewmat{\tilde{\vect{\theta}}_I^b} \tilde{\vect{v}}_{b/I}^b.
\end{align}
We assume the error-state components to be small, neglecting the higher-order
terms to get the final expression
\begin{align}
  \dot{\tilde{\vect{p}}}_{b/I}^I
  &=
  \left( \hat{R}_I^b \right)^\transpose \tilde{\vect{v}}_{b/I}^b
  - \left( \hat{R}_I^b \right)^\transpose \skewmat{\hat{\vect{v}}_{b/I}^b}
  \tilde{\vect{\theta}}_I^b.
\end{align}

\subsubsection{UAV Attitude Error-State Dynamics}
To derive the error-state dynamics for the UAV attitude state, we
follow~\cite{koch2017relative}, starting
with~\eqref{eq:quat_true_state} and letting $\tilde{\q}_I^b = \exp_{\q} \left(
  \tilde{\vect{\theta}}_I^b \right)$ such that
\begin{equation}
  \q_I^b  = \hat{\q}_I^b \otimes \tilde{\q}_I^b
  \right).
\end{equation}
Differentiating with respect to time results in
\begin{equation}
  \dot{\q}_I^b  = \dot{\hat{\q}}_I^b \otimes \tilde{\q}_I^b + 
  \hat{\q}_I^b \otimes \dot{\tilde{\q}}_I^b
  \right)
\end{equation}
which we multiply all terms on the left by $\left( \hat{\q}_I^b \right)^{-1}$
and simplify to yield
\begin{align}
  \left( \hat{\q}_I^b \right)^{-1} \otimes \dot{\q}_I^b  &= \left( \hat{\q}_I^b
  \right)^{-1} \otimes \dot{\hat{\q}}_I^b \otimes \tilde{\q}_I^b + 
  \left( \hat{\q}_I^b \right)^{-1} \otimes \hat{\q}_I^b \otimes \dot{\tilde{\q}}_I^b
  \right) \\
  \left( \hat{\q}_I^b \right)^{-1} \otimes \dot{\q}_I^b  &= \left( \hat{\q}_I^b
  \right)^{-1} \otimes \dot{\hat{\q}}_I^b \otimes \tilde{\q}_I^b + 
  \dot{\tilde{\q}}_I^b
  \right).
\end{align}
We then rearrange the above equation and simplify using the true-state and
estimated-state dynamics of the UAV attitude state given
in~\eqref{eq:uav_dynamics} and~\eqref{eq:estimated_dynamics} along with the
error-state definition from~\eqref{eq:quat_error_state}:
\begin{align}
  \dot{\tilde{\q}}_I^b &=
  \left( \hat{\q}_I^b \right)^{-1} \otimes \dot{\q}_I^b  - \left( \hat{\q}_I^b
  \right)^{-1} \otimes \dot{\hat{\q}}_I^b \otimes \tilde{\q}_I^b
  \right) \\
  &=
  \left( \hat{\q}_I^b \right)^{-1} \otimes \q_I^b \otimes
  \begin{pmatrix}
    0 \\
    \frac{1}{2} \left( \bar{\vect{\omega}}_{b/I}^b - \vect{\beta}_\omega
    -\vect{\upsilon}_\omega \right)
  \end{pmatrix}
  - \left( \hat{\q}_I^b
  \right)^{-1} \otimes \hat{\q}_I^b \otimes
  \begin{pmatrix}
    0 \\
    \frac{1}{2} \left( \bar{\vect{\omega}}_{b/I}^b - \hat{\vect{\beta}}_\omega
  \end{pmatrix}
  \otimes \tilde{\q}_I^b
  \right) \\
  &=
  \label{eq:intermed_eq1}
  \frac{1}{2} \tilde{\q}_I^b \otimes
  \begin{pmatrix}
    0 \\
    \left( \bar{\vect{\omega}}_{b/I}^b - \vect{\beta}_\omega -
    \vect{\upsilon}_\omega \right)
  \end{pmatrix}
  - \frac{1}{2}
  \begin{pmatrix}
    0 \\
    \left( \bar{\vect{\omega}}_{b/I}^b - \hat{\vect{\beta}}_\omega
  \end{pmatrix}
  \otimes \tilde{\q}_I^b
  \right). 
\end{align}
Applying~\eqref{eq:quat_otimes_product} and noting that the quaternion group
operator $\otimes$ can also be written as
\begin{equation}
	\q^a \otimes \q^b = \begin{pmatrix} q_0^b & \left(-\bar{\q}^{b}\right)^\transpose \\ \bar{\q}^b & q^b_0 I - \skewmat{\bar{\q}^b} \end{pmatrix}
	\begin{pmatrix} q^a \\ \bar{\q}^a \end{pmatrix},
\end{equation}
we can expand~\eqref{eq:intermed_eq1} as matrix-like products
\begin{align}
  \dot{\tilde{\q}}_I^b &=
  \frac{1}{2}
  \begin{pmatrix}
    0 & -\left( \bar{\vect{\omega}}_{b/I}^b - \vect{\beta}_\omega -
      \vect{\upsilon}_\omega
    \right)^\transpose \\
      \left( \bar{\vect{\omega}}_{b/I}^b - \vect{\beta}_\omega -
    \vect{\upsilon}_\omega \right) &
    -\skewmat{\bar{\vect{\omega}}_{b/I}^b - \vect{\beta}_\omega -
    \vect{\upsilon}_\omega }
  \end{pmatrix}
  \tilde{\q}_I^b \\
                       & \qquad - \frac{1}{2}
  \begin{pmatrix}
    0 & -\left( \bar{\vect{\omega}}_{b/I}^b - \hat{\vect{\beta}}_\omega
    \right)^\transpose \\
      \left( \bar{\vect{\omega}}_{b/I}^b - \hat{\vect{\beta}}_\omega \right) &
      \skewmat{\bar{\vect{\omega}}_{b/I}^b - \hat{\vect{\beta}}_\omega }
  \end{pmatrix}
  \tilde{\q}_I^b
  \right). \nonumber
\end{align}
We then simplify the previous equation using the error-state definition
$\tilde{\vect{\beta}}_\omega \triangleq \vect{\beta}_\omega -
\hat{\vect{\beta}}_\omega$ giving
\begin{align}
  \dot{\tilde{\q}}_I^b &=
  \frac{1}{2}
  \begin{pmatrix}
    0 & -\left( - \tilde{\vect{\beta}}_\omega -
      \vect{\upsilon}_\omega
    \right)^\transpose \\
    \left( - \tilde{\vect{\beta}}_\omega -
    \vect{\upsilon}_\omega \right) &
    \skewmat{ -2\bar{\vect{\omega}}_{b/I}^b + 2\hat{\vect{\beta}}_\omega
      + \tilde{\vect{\beta}}_\omega + \vect{\upsilon}_\omega }
  \end{pmatrix}
  \tilde{\q}_I^b
\end{align}
which implies that
\begin{align}
  \begin{pmatrix}
    1 \\
    \frac{1}{2} \dot{\tilde{\vect{\theta}}}_I^b
  \end{pmatrix}
  &=
  \frac{1}{2}
  \begin{pmatrix}
    0 & -\left( - \tilde{\vect{\beta}}_\omega -
      \vect{\upsilon}_\omega
    \right)^\transpose \\
    \left( - \tilde{\vect{\beta}}_\omega -
    \vect{\upsilon}_\omega \right) &
    \skewmat{ -2\bar{\vect{\omega}}_{b/I}^b + 2\hat{\vect{\beta}}_\omega
      + \tilde{\vect{\beta}}_\omega + \vect{\upsilon}_\omega }
  \end{pmatrix}
  \begin{pmatrix}
    1 \\
    \frac{1}{2} \tilde{\vect{\theta}}_I^b
  \end{pmatrix}.
\end{align}
To get the final expression, we drop the scalar equation and neglect
second-order terms to yield
\begin{align}
  \dot{\tilde{\vect{\theta}}}_I^b
  &=
    \left( - \tilde{\vect{\beta}}_\omega -
    \vect{\upsilon}_\omega \right) 
    + \frac{1}{2}
    \skewmat{ -2\bar{\vect{\omega}}_{b/I}^b + 2\hat{\vect{\beta}}_\omega
      + \tilde{\vect{\beta}}_\omega + \vect{\upsilon}_\omega }
    \tilde{\vect{\theta}}_I^b \\
  &\approx
  -\skewmat{ \bar{\vect{\omega}}_{b/I}^b - \hat{\vect{\beta}}_\omega}
    \tilde{\vect{\theta}}_I^b
    - \tilde{\vect{\beta}}_\omega -
    \vect{\upsilon}_\omega .
\end{align}

\subsubsection{UAV Velocity Error-State Dynamics}
Similar to the UAV position error-state derivation, to derive the error-state
dynamics for the UAV velocity state, we begin with the time derivative of the
error-state definition
\begin{equation}
  \dot{\tilde{\vect{v}}}_{b/I}^I = \dot{\vect{v}}_{b/I}^I -
  \dot{\hat{\vect{v}}}_{b/I}^I.
\end{equation}
We then substitue in the dynamics from~\eqref{eq:uav_dynamics}
and~\eqref{eq:estimated_dynamics} and expand using the error-state definitions
and approximations
\begin{align}
  \dot{\tilde{\vect{v}}}_{b/I}^I
  =&
  R_I^b \vect{g}
  +
  \skewmat{\vect{v}_{b/I}^b}
  \left( \bar{\vect{\omega}}_{b/I}^b - \vect{\beta}_\omega -
  \vect{\upsilon}_\omega \right)
  +
  \left( \bar{\vect{a}} - \vect{\beta}_a - \vect{\upsilon}_a \right) \\
                                  & \qquad -
                                  \left( \hat{R}_I^b \vect{g}
  +
  \skewmat{\hat{\vect{v}}_{b/I}^b}
  \left( \bar{\vect{\omega}}_{b/I}^b - \hat{\vect{\beta}}_\omega \right)
  +
\left( \bar{\vect{a}} - \hat{\vect{\beta}}_a \right) \right) \nonumber \\
  \approx&
  \left( I - \skewmat{\tilde{\vect{\theta}}_I^b }\right) \hat{R}_I^b \vect{g}
  +
  \skewmat{ \hat{\vect{v}}_{b/I}^b + \tilde{\vect{v}}_{b/I}^b } 
  \left( \bar{\vect{\omega}}_{b/I}^b - \hat{\vect{\beta}}_\omega -
    \tilde{\vect{\beta}}_\omega -
  \vect{\upsilon}_\omega \right) \\
                                  & \qquad 
  + \left( \bar{\vect{a}} - \hat{\vect{\beta}}_a - \tilde{\vect{\beta}}_a - \vect{\upsilon}_a \right)
  - \left( \hat{R}_I^b \vect{g}
  +
  \skewmat{\hat{\vect{v}}_{b/I}^b}
  \left( \bar{\vect{\omega}}_{b/I}^b - \hat{\vect{\beta}}_\omega \right)
  +
\left( \bar{\vect{a}} - \hat{\vect{\beta}}_a \right) \right) \nonumber
\end{align}
which we can simplify and neglect high-order terms to yield the final
expression:
\begin{align}
  \dot{\tilde{\vect{v}}}_{b/I}^I
  \approx&
  \skewmat{ \hat{R}_I^b \vect{g} } \tilde{\vect{\theta}}_I^b 
  -
  \skewmat{ \hat{\vect{v}}_{b/I}^b } \tilde{\vect{\beta}}_\omega
  -
  \skewmat{ \hat{\vect{v}}_{b/I}^b } \vect{\upsilon}_\omega
  -
  \skewmat{ \bar{\omega}_{b/I}^b - \hat{\vect{\beta}}_\omega }
  \tilde{\vect{v}}_{b/I}^b
  -
  \tilde{\vect{\beta}}_a
  -
  \vect{\upsilon}_a.
\end{align}

\subsubsection{UAV Bias Error-State Dynamics}
\subsubsection{Landing Vehicle Position Error-State Dynamics}
\subsubsection{Landing Vehicle Velocity Error-State Dynamics}
\subsubsection{Landing Vehicle Attitude Error-State Dynamics}
\subsubsection{Landing Vehicle Angular Rate Error-State Dynamics}
\subsubsection{Visual Feature Vector Error-State Dynamics}

